# GitHub Action: Automatische Versionierung, Kompilierung und Veröffentlichung
#
# Dieser Workflow wird bei einem Push auf den 'main'-Branch ausgelöst.
# 1. Job 'create-release':
#    - Analysiert Commit-Nachrichten (feat:, fix:, etc.).
#    - Bestimmt automatisch die neue Versionsnummer (z.B. v1.1.0).
#    - Erstellt einen Git-Tag und einen GitHub Release-ENTWURF.
# 2. Job 'build-and-upload':
#    - Wartet auf die Erstellung des Releases.
#    - Kompiliert die Anwendung für Windows.
#    - Lädt die fertige .exe-Datei als ZIP zum erstellten Release hoch.
# 3. Job 'publish-release':
#    - Wartet auf den erfolgreichen Upload.
#    - Veröffentlicht den Release-Entwurf.

name: Automatic Release

on:
  push:
    branches:
      - main # oder master, je nach deinem Repository

jobs:
  # Job 1: Version bestimmen und Release erstellen
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # um Tags und Releases zu erstellen
      issues: write   # optional, für Release-Notes
      pull-requests: write # optional, für Release-Notes
    outputs:
      # Gibt die Upload-URL und den Tag-Namen an den nächsten Job weiter
      upload_url: ${{ steps.semantic.outputs.upload_url }}
      tag_name: ${{ steps.semantic.outputs.tag }}

    steps:
      - name: 1. Code auschecken (mit gesamter Historie)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Notwendig für die Versionsanalyse

      - name: 2. Automatische Versionierung und Release-Erstellung
        id: semantic
        uses: go-semantic-release/action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Erzwingt das Erstellen eines Entwurfs und andere Einstellungen via Umgebungsvariablen
          GSR_DRAFT: "true"
          GSR_FILES: "false"
          GSR_PARSER: "conventional-commits"
          GSR_CHANGELOG: "conventional-commits"

  # Job 2: Anwendung kompilieren und hochladen
  build-and-upload:
    # Startet erst, wenn 'create-release' erfolgreich war und ein neues Release erstellt wurde
    needs: create-release
    if: needs.create-release.outputs.tag_name != ''
    runs-on: windows-latest # Notwendig, da eine Windows .exe erstellt wird
    permissions:
      contents: write # Erforderlich, um das Artefakt zum Release hochladen zu können

    steps:
      - name: 1. Code für das neue Tag auschecken
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}

      - name: 2. Python-Umgebung einrichten
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Abhängigkeiten installieren
        run: pip install -r requirements.txt

      - name: 4. Anwendung mit PyInstaller kompilieren
        run: pyinstaller --name "Logfile-Viewer" --onefile --windowed --icon="icon.ico" --add-data "icon.ico;." "logviewer.py"

      - name: 5. Release-Artefakt vorbereiten (ZIP)
        id: prepare-artifact
        shell: pwsh
        run: |
          $tagName = "${{ needs.create-release.outputs.tag_name }}"
          $zipPath = "Logfile-Viewer-portable-$tagName.zip"
          Compress-Archive -Path dist/Logfile-Viewer.exe -DestinationPath $zipPath
          echo "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: 6. Artefakt zum GitHub Release hochladen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ needs.create-release.outputs.tag_name }} ${{ steps.prepare-artifact.outputs.zip_path }}

  # Job 3: Release veröffentlichen
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    # Läuft erst, nachdem der Build-Job erfolgreich war
    needs: [create-release, build-and-upload]
    if: success() && needs.create-release.outputs.tag_name != ''
    permissions:
      contents: write # Benötigt, um den Release-Status zu ändern
    steps:
      - name: Release als "Published" markieren
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit ${{ needs.create-release.outputs.tag_name }} --draft=false